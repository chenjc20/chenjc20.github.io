---
title: CLP: Efficient and Scalable Search on Compressed Text Logs
tags: 
  - tag: Compression
  - tag: Logs
categories: OSDI
author: 魏钧宇
---

这篇文章是发表在OSDI2020上的一篇文章，主要实现了一个能够实现在压缩之后的非结构化的文本日志上进行快速的检索的工具CLP。本文强调，日志压缩和日志查询存在互相对立的问题。广泛使用的日志检索工具（Elasticsearch和Splunk）能够提供高效的日志检索，但是他们对应的Index通常规模很大，而相对应的一些常用的日志压缩工具，比如Gzip，能够提高较高的日志压缩率，但是他们在检索之前都需要首先做一次解压操作。CLP核心增益来自于一个领域专用的压缩方法和一个充分利用了文本日志中高度重复信息的检索工具。

## 整体介绍
1. 现代的科技公司每日产生PB量级的日志数据，这些数据不能够轻易丢弃，同时还会在很多领域用到这样的一些日志数据，因此造成了较高的存储成本。同时另一方面一些类似于Elastic和Splunk的工具能够实现较高的检索速度，同时也在快速的发展，他们的主要思想就是只解压那些可能会包含有要检索的日志的数据块，但是为了能够完成这样的定位，他们需要建立一层极为复杂的索引，索引的规则通常和原始的日志规模差不多了。
2. 为了避免这样的一些问题，现在的日志公司通常会使用gzip和zstandard进行压缩，但是这样的一些压缩的方法通常采用的是LZ77路径的策略，也就是采用内部编码一个宏格式的思路，在这样的一种内部编码宏格式之上实现检索是一个非常慢而且很痛苦的过程。
3. 为了能够弥合这样的一个鸿沟（一个压缩和检索的鸿沟），本文提出一种无损压缩的方法，该方法能够同时支持在压缩数据上的高效检索，同时不需要解压所有的日志信息。领域专用的日志压缩方法将所有重复的Pattern提取到一个字典中，然后将他们和编码的日志数据分开存储（日志parser的过程），然后检索的过程将首先检索这些字典，在确认了字典中可能有命中的时候，再尝试去检索编码的日志信息，这是基于对于现代软件日志的观察 -> 发现其中有大量的可能重复信息。
4. 本文还强调支持通配符将会给检索过程带来不少麻烦，因此还专门用一章来讨论通配符的问题。
5. 本文构建了一个端到端的日志管理工具CLP，能够实现实时的数据压缩、检索、分析和报警。CLP和日志的格式无关，能够在压缩数据上检索和分析的同时能够降低归档数据的规模。实验上来看，压缩率比Gzip要高2倍，比通常使用的在压缩数据上检索的工具速度要高8倍，同时比Splunk和Elastic速度要高4.2和1.3倍。
6. 本文认为CLP的主要局限性在于仅能够支持文本数据，不能很好地支持二进制的数据

## 主要设计
1. 本文采用的方法是和我们类似的，先编码后打包的思路。在编码部分首先将日志数据解析成模板号（Log type），时间戳，变量（Variable type）。这边的LogType相当于我们的模板，然后变量由被分成字典变量和非字典变量。主要的存储格式如下图所示。打包部分则主要使用的是Zstd进行压缩。
2. 在日志解析部分，本文采用的方法是运用用户指定的规则来实现变量的匹配。用户会预先定义，分隔符、字典变量的格式（task_\d+），非字典变量的格式等，然后会首先通过一个tokenize的过程将原始的日志信息做切分，在切分成一个个token之后，再在他们上匹配是否有符合规则的可以提取的变量。
3. 在日志压缩时，每一条日志将首先基于之前预先定义的变量格式被解析成时间戳、日志类型ID和变量三个部分。对于每一个变量，将首先使用一个变量字典，其中包含的是三个不同的变量格式，每一个格式有一个自己对应的ID，然后这个格式会通过指针指向在当前这个Shema下包含的变量值，然后每一个值会指明自己所对应的那些Segments。
4. 针对这样的一种特定的存储方式，如果需要解压EncodedMessage中的任何一条数据，可以首先通过LogTypeID确定对应的LogTypeID，然后再通过LogTypeID中的编码的信息来确定不同的LogType，以及需要的那些VariableDictionary。接下来再在VariableDict中确定对应的每一个VariableID的实际的Value，使用编码的数据确定日志的值，然后将上述的信息全部填入到LogType之中，恢复原始的日志。

## 实验结果
1. 主要数据集有四个：/var/log* -> 7GB -> 30台Linux服务器在过去6年中的运行结果，OpenStack-33GB -> 在OpenStack上跑Rally这个Benchmark得到的结果，Apache-6TB
2. 主要对比压缩速度和压缩率、检索性能、横向、纵向、容量的扩展

 
了解更多请关注: [论文原文](https://dl.acm.org/doi/10.14778/3380750.3380761) 
